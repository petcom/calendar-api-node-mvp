<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Users & Groups</title>
  <style>
    ul { list-style: none; padding: 0; }
    li { cursor: pointer; margin: 0.25em 0; }
    .selected { background-color: #eef; font-weight: bold; }
    .section { border: 1px solid #ccc; padding: 1em; margin-bottom: 2em; }
  </style>
</head>
<body>
  <h1>Group & User Administration</h1>

  <div class="section">
    <h2>Groups</h2>
    <ul id="groupList"></ul>
    <div id="groupFormContainer" style="display:none;">
      <label>Group ID:</label><br>
      <input type="text" id="groupId" readonly><br>
      <label>Group Name:</label><br>
      <input type="text" id="groupName"><br><br>
      <button onclick="saveGroup()">Save Group</button>
    </div>
  </div>

  <div class="section">
    <h2>Users</h2>
    <ul id="userList"></ul>
    <div id="userFormContainer" style="display:none;">
      <label>Username:</label><br>
      <input type="text" id="username" readonly><br>
      <label>Full Name:</label><br>
      <input type="text" id="fullName"><br>
      <label>Token Expiry:</label><br>
      <input type="text" id="tokenExpiry" placeholder="e.g., 10m or 1h"><br>
      <fieldset>
        <legend>Group Membership</legend>
        <div id="groupCheckboxes"></div>
      </fieldset><br>
      <button onclick="saveUser()">Save User</button>
    </div>
  </div>

  <script>
    let groups = [];
    let users = [];

    async function loadGroups() {
      const res = await fetch('/api/groups');
      groups = await res.json();
      const ul = document.getElementById('groupList');
      ul.innerHTML = '';
      groups.forEach(group => {
        const li = document.createElement('li');
        li.textContent = `${group.id} - ${group.name}`;
        li.onclick = () => showGroupForm(group);
        ul.appendChild(li);
      });
    }

    function showGroupForm(group) {
      document.getElementById('groupFormContainer').style.display = 'block';
      document.getElementById('groupId').value = group.id;
      document.getElementById('groupName').value = group.name;
    }

    async function saveGroup() {
      const id = document.getElementById('groupId').value;
      const name = document.getElementById('groupName').value;
      await fetch(`/api/groups/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, name })
      });
      alert('Group saved');
      loadGroups();
    }

    async function loadUsers() {
      const res = await fetch('/api/users');
      users = await res.json();
      const ul = document.getElementById('userList');
      ul.innerHTML = '';
      users.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user.username;
        li.onclick = () => showUserForm(user);
        ul.appendChild(li);
      });
    }

    function showUserForm(user) {
      document.getElementById('userFormContainer').style.display = 'block';
      document.getElementById('username').value = user.username;
      document.getElementById('fullName').value = user.full_name || '';
      document.getElementById('tokenExpiry').value = user.token_expiry || '';

      const container = document.getElementById('groupCheckboxes');
      container.innerHTML = '';
      groups.forEach(group => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = group.id;
        checkbox.id = `group_${group.id}`;
        checkbox.checked = (user.groups || []).includes(group.id);

        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = group.name;

        container.appendChild(checkbox);
        container.appendChild(label);
        container.appendChild(document.createElement('br'));
      });
    }

    async function saveUser() {
      const username = document.getElementById('username').value;
      const full_name = document.getElementById('fullName').value;
      const token_expiry = document.getElementById('tokenExpiry').value;
      const checkboxes = document.querySelectorAll('#groupCheckboxes input[type=checkbox]');
      const groups = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

      await fetch(`/api/users/${username}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ full_name, token_expiry, groups })
      });
      alert('User saved');
      loadUsers();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadGroups();
      await loadUsers();
    });
  </script>
</body>
</html>
